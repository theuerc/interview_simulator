{% extends "layout.html" %}

{% block content %}

    <div class="container">
        <h1>Welcome back, {{ current_user.username }}!</h1>
        <p>Please press the button to begin your interview.</p>
    
        <h2>Talk to HiringManagerGPT</h2>
        <button id="recordButton">Record</button>
        <ul id="recordingsList"></ul>

        <form id="transcribeForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        </form>

        <script>
            const recordButton = document.getElementById('recordButton');
            const recordingsList = document.getElementById('recordingsList');

            let chunks = [];
            let mediaRecorder;

            recordButton.onclick = async () => {
                if (recordButton.textContent === 'Record') {
                // Request access to the microphone
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                // Create a new MediaRecorder instance
                mediaRecorder = new MediaRecorder(stream);

                // Start recording and save the data to the 'chunks' array
                mediaRecorder.start();
                mediaRecorder.ondataavailable = (e) => {
                    chunks.push(e.data);
                };

                // Update the button text and enable/disable buttons
                recordButton.textContent = 'Stop';
                recordingsList.innerHTML = '';
                } else {
                // Stop the MediaRecorder and process the recorded data
                mediaRecorder.stop();
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'audio/webm' });

                    // Get the CSRF token from the HTML form
                    const csrfToken = document.querySelector('input[name="csrf_token"]').value;

                    // Create a new FormData object and append the audio file 
                    const formData = new FormData();
                    formData.append('audio', blob, 'recording.webm');

                    fetch('/users/transcribe', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                        },
                        body: formData,
                    })
                    .then((response) => response.json())
                    .then((data) => {
                        // Handle the transcribed text, e.g., display it on the page
                        console.log(data.transcription);
                    })
                    .catch((error) => {
                        console.error('Error uploading audio:', error);
                    });

                    // Reset the state
                    chunks = [];
                    recordButton.textContent = 'Record';
                };
                }
            };
        </script>
    </div>
{% endblock %}